import streamlit as st
import ollama

# --- Konfiguracja aplikacji ---
st.set_page_config(page_title="Analiza SOLID & OWASP", layout="wide")
st.title(" Analiza kodu: SOLID & OWASP")

# --- Formularz do wklejenia kodu ---
code = st.text_area("Wklej kod 藕r贸dowy do analizy:", height=300, placeholder="Wklej tutaj kod...")

# --- Wyb贸r typu analizy ---
analysis_type = st.radio(
    "Wybierz rodzaj analizy:",
    ["Analiza SOLID", "Analiza OWASP", "Analiza SOLID + OWASP"]
)

# --- Wyb贸r modelu Ollama ---
model = st.selectbox("Wybierz model Ollama:", ["codegemma:2b", "gemma3:4b"])

# --- Przycisk analizy ---
analyze = st.button("Analizuj kod")

# --- Logika analizy ---
if analyze and code.strip():
    with st.spinner("Model analizuje kod..."):

        # --- Budowanie promptu na podstawie wyboru ---
        if analysis_type == "Analiza SOLID":
            instructions = """
Przeanalizuj poni偶szy kod pod ktem zasad SOLID:
1. Pojedyncza odpowiedzialno
2. Otwarto/Zamknito
3. Zastpowalno Liskov
4. Segregacja interfejs贸w
5. Odwr贸cenie zale偶noci

Zidentyfikuj naruszenia, opisz je oraz zaproponuj poprawki.
"""
        elif analysis_type == "Analiza OWASP":
            instructions = """
Przeanalizuj poni偶szy kod pod ktem luk bezpieczestwa z listy OWASP Top 10 (np. SQL Injection, XSS, bdna autoryzacja, niewaciwe przechowywanie danych itp.).

Zidentyfikuj potencjalne zagro偶enia, opisz je i zaproponuj poprawki.
"""
        else:
            instructions = """
Przeanalizuj poni偶szy kod pod ktem:
1. Zasad SOLID (pojedyncza odpowiedzialno, otwarto/zamknito, podstawienie Liskov, segregacja interfejs贸w, odwr贸cenie zale偶noci).
2. Potencjalnych zagro偶e bezpieczestwa zgodnych z OWASP Top 10 (np. SQL Injection, XSS, brak kontroli dostpu, nieprawidowe uwierzytelnianie itd.).

Dla ka偶dego wykrytego problemu:
- wska偶 lokalizacj,
- opisz dlaczego to jest problem,
- zaproponuj rozwizanie.
"""

        prompt = f"{instructions}\nKod:\n```{code}```"

        response = ollama.chat(
            model=model,
            messages=[
                {"role": "user", "content": prompt}
            ]
        )

        st.subheader(" Wynik analizy:")
        st.markdown(response['message']['content'])

elif analyze:
    st.warning("锔 Wklej kod przed uruchomieniem analizy.")
